# ä¿®å¤åŒä¸€ç”¨æˆ·å‘é€ä¸¤æ¡é—®é¢˜

## é—®é¢˜æè¿°

**ç°è±¡**ï¼šå½“ç”¨æˆ·å‘é€ä¸€æ¡æ¶ˆæ¯åï¼ŒAIå®¢æœä¼šè‡ªåŠ¨å›å¤ä¸¤æ¡å‡ ä¹ç›¸åŒçš„æ¶ˆæ¯ï¼Œä¸”å‘é€æ—¶æ²¡æœ‰ç­‰å¾…3ç§’çš„å»¶è¿Ÿã€‚

**å½±å“**ï¼š
- ç”¨æˆ·ä½“éªŒå·®ï¼Œæ”¶åˆ°é‡å¤æ¶ˆæ¯
- è¿åäº†åŸæœ‰çš„"æ¯æ¬¡åªå›å¤æœ€åä¸€æ¡æ¶ˆæ¯"çš„è®¾è®¡
- æ²¡æœ‰éµå®ˆ3ç§’å»¶è¿Ÿçš„äººå·¥æ¨¡æ‹Ÿæœºåˆ¶

## é—®é¢˜æ ¹æºåˆ†æ

### 1. å›å¤æµç¨‹ä¸­çš„åŒé‡è§¦å‘

åœ¨ `ReplyCoordinator.coordinate_reply()` æ–¹æ³•ä¸­ï¼ˆ`src/core/reply_coordinator.py`ï¼‰ï¼Œå½“å¤§æ¨¡å‹ç”Ÿæˆå›å¤åï¼Œä¼š**åŒæ—¶è§¦å‘ä¸¤ä¸ªå›è°ƒ**ï¼š

```python
# reply_coordinator.py ç¬¬106-125è¡Œ
def _on_llm_reply_ready(self, request_id: str, reply_text: str):
    # ... çœç•¥éƒ¨åˆ†ä»£ç  ...
    
    # 1. è°ƒç”¨ callback å‡½æ•°
    if callback:
        callback(True, processed_reply)  # ç¬¬123è¡Œ
    
    # 2. å‘é€ reply_prepared ä¿¡å·
    self.reply_prepared.emit(session_id, processed_reply)  # ç¬¬125è¡Œ
```

### 2. MessageProcessor ä¸­çš„é‡å¤å¤„ç†

åœ¨ `MessageProcessor` ä¸­ï¼ˆ`src/core/message_processor.py`ï¼‰ï¼Œå­˜åœ¨ä¸¤ä¸ªå¤„ç†å›å¤çš„è·¯å¾„ï¼š

**è·¯å¾„1ï¼šé€šè¿‡ callback ç›´æ¥å‘é€**
```python
# message_processor.py ç¬¬601-615è¡Œï¼ˆä¿®å¤å‰ï¼‰
def on_reply(success, reply_text):
    if success and reply_text:
        # ç«‹å³å‘é€å›å¤ï¼Œæ²¡æœ‰å»¶è¿Ÿï¼
        self._send_reply(session.session_id, reply_text)  # ç¬¬606è¡Œ
```

**è·¯å¾„2ï¼šé€šè¿‡ reply_prepared ä¿¡å·å‘é€**
```python
# message_processor.py ç¬¬70è¡Œ - åˆå§‹åŒ–æ—¶è¿æ¥ä¿¡å·
self.coordinator.reply_prepared.connect(self._on_reply_prepared)

# message_processor.py ç¬¬331-335è¡Œ
def _on_reply_prepared(self, session_id: str, reply_text: str):
    # å»¶è¿Ÿ3ç§’å‘é€
    QTimer.singleShot(3000, lambda: self._send_reply(session_id, reply_text))
```

### 3. é—®é¢˜æ€»ç»“

- **ç¬¬ä¸€æ¬¡å‘é€**ï¼šæ¥è‡ª callback ä¸­çš„ `_send_reply`ï¼ˆç¬¬606è¡Œï¼‰ï¼Œ**ç«‹å³å‘é€ï¼Œæ— å»¶è¿Ÿ**
- **ç¬¬äºŒæ¬¡å‘é€**ï¼šæ¥è‡ª `reply_prepared` ä¿¡å·è§¦å‘çš„ `_on_reply_prepared`ï¼ˆç¬¬335è¡Œï¼‰ï¼Œ**3ç§’åå‘é€**
- ç»“æœï¼šåŒä¸€æ¡å›å¤è¢«å‘é€äº†ä¸¤æ¬¡ï¼Œä¸”ç¬¬ä¸€æ¬¡æ²¡æœ‰å»¶è¿Ÿ

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šåœ¨ `_on_reply_prepared` ä¸­æ·»åŠ é˜²é‡å¤æ£€æŸ¥

```python
# src/core/message_processor.py ç¬¬331-340è¡Œ
def _on_reply_prepared(self, session_id: str, reply_text: str):
    """å›å¤å‡†å¤‡å°±ç»ª"""
    # å¦‚æœæ­£åœ¨æ‰‹åŠ¨å¤„ç†å›å¤ï¼ˆé€šè¿‡ _generate_reply_from_historyï¼‰ï¼Œè·³è¿‡ä¿¡å·è§¦å‘çš„å›å¤
    if self._is_processing_reply:
        self.log_message.emit(f"â¸ï¸ å·²åœ¨æ‰‹åŠ¨å¤„ç†å›å¤ï¼Œè·³è¿‡ä¿¡å·è§¦å‘")
        return
    
    # å»¶è¿Ÿ3ç§’å‘é€ï¼Œæ¨¡æ‹Ÿäººå·¥å›å¤ï¼Œé¿å…è¢«æ£€æµ‹
    self.log_message.emit(f"â³ ç­‰å¾…3ç§’åå‘é€å›å¤...")
    QTimer.singleShot(3000, lambda: self._send_reply(session_id, reply_text))
```

**ä½œç”¨**ï¼šå½“ `_is_processing_reply` æ ‡å¿—ä¸º `True` æ—¶ï¼Œè¯´æ˜æ­£åœ¨é€šè¿‡ `_generate_reply_from_history` æ‰‹åŠ¨å¤„ç†å›å¤ï¼Œæ­¤æ—¶è·³è¿‡ä¿¡å·è§¦å‘çš„å›å¤ï¼Œé¿å…é‡å¤å‘é€ã€‚

### ä¿®å¤2ï¼šåœ¨ callback ä¸­æ·»åŠ 3ç§’å»¶è¿Ÿ

```python
# src/core/message_processor.py ç¬¬601-612è¡Œ
def on_reply(success, reply_text):
    if success and reply_text:
        self.log_message.emit(f"âœ… å¤§æ¨¡å‹å›å¤å®Œæˆ")
        self.log_message.emit(f"ğŸ’¬ å›å¤å†…å®¹: {reply_text[:100]}...")
        # æ·»åŠ 3ç§’å»¶è¿Ÿåå‘é€å›å¤
        self.log_message.emit(f"â³ ç­‰å¾…3ç§’åå‘é€å›å¤...")
        QTimer.singleShot(3000, lambda: self._send_reply_and_reset(session.session_id, reply_text))
    else:
        self.log_message.emit(f"âŒ å¤§æ¨¡å‹ç”Ÿæˆå›å¤å¤±è´¥")
        # é‡ç½®å¤„ç†çŠ¶æ€
        self._is_processing_reply = False
```

**ä½œç”¨**ï¼šç¡®ä¿é€šè¿‡ callback å‘é€çš„å›å¤ä¹Ÿæœ‰3ç§’å»¶è¿Ÿï¼Œç¬¦åˆäººå·¥å›å¤çš„æ¨¡æ‹Ÿæœºåˆ¶ã€‚

### ä¿®å¤3ï¼šæ–°å¢ `_send_reply_and_reset` æ–¹æ³•

```python
# src/core/message_processor.py ç¬¬626-630è¡Œ
def _send_reply_and_reset(self, session_id: str, reply_text: str):
    """å‘é€å›å¤å¹¶é‡ç½®å¤„ç†çŠ¶æ€"""
    self._send_reply(session_id, reply_text)
    # å»¶è¿Ÿé‡ç½®å¤„ç†çŠ¶æ€ï¼Œç­‰å¾…å‘é€å®Œæˆ
    QTimer.singleShot(2000, lambda: setattr(self, '_is_processing_reply', False))
```

**ä½œç”¨**ï¼š
- å‘é€å›å¤åï¼Œå»¶è¿Ÿ2ç§’é‡ç½® `_is_processing_reply` æ ‡å¿—
- ç¡®ä¿åœ¨å‘é€å®Œæˆå‰ï¼Œä¸ä¼šå¤„ç†æ–°çš„å›å¤è¯·æ±‚
- é˜²æ­¢åœ¨å‘é€è¿‡ç¨‹ä¸­è¢«å…¶ä»–å›å¤æµç¨‹å¹²æ‰°

## ä¿®å¤æ•ˆæœ

ä¿®å¤åï¼Œç³»ç»Ÿè¡Œä¸ºå¦‚ä¸‹ï¼š

âœ… **æ¯æ¬¡åªå›å¤ä¸€æ¡æ¶ˆæ¯**  
âœ… **å›å¤å‰ç­‰å¾…3ç§’**ï¼ˆæ¨¡æ‹Ÿäººå·¥å›å¤ï¼‰  
âœ… **æ£€æŸ¥æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯å¦æ˜¯ç”¨æˆ·å‘çš„**ï¼ˆå·²æœ‰é€»è¾‘ï¼Œç¬¬534-536è¡Œï¼‰  
âœ… **é˜²æ­¢é‡å¤å¤„ç†åŒä¸€æ¡æ¶ˆæ¯**ï¼ˆé€šè¿‡ `_is_processing_reply` æ ‡å¿—ï¼‰  

## ç›¸å…³ä»£ç ä½ç½®

### ä¿®æ”¹çš„æ–‡ä»¶
- `src/core/message_processor.py`

### å…³é”®ä»£ç ä½ç½®
1. **ç¬¬48è¡Œ**ï¼š`_is_processing_reply` æ ‡å¿—å®šä¹‰
2. **ç¬¬331-340è¡Œ**ï¼š`_on_reply_prepared` æ–¹æ³•ï¼ˆæ·»åŠ é˜²é‡å¤æ£€æŸ¥ï¼‰
3. **ç¬¬556-625è¡Œ**ï¼š`_generate_reply_from_history` æ–¹æ³•ï¼ˆä¿®æ”¹ callback é€»è¾‘ï¼‰
4. **ç¬¬626-630è¡Œ**ï¼š`_send_reply_and_reset` æ–°æ–¹æ³•

## æµ‹è¯•éªŒè¯

**æµ‹è¯•æ­¥éª¤**ï¼š
1. å¯åŠ¨ AI å®¢æœ
2. ç”¨æˆ·å‘é€ä¸€æ¡æ¶ˆæ¯
3. è§‚å¯Ÿæ—¥å¿—å’ŒèŠå¤©ç•Œé¢

**é¢„æœŸç»“æœ**ï¼š
- æ—¥å¿—æ˜¾ç¤º "â³ ç­‰å¾…3ç§’åå‘é€å›å¤..."
- 3ç§’åå‘é€ä¸€æ¡å›å¤
- ä¸ä¼šå‡ºç°é‡å¤çš„å›å¤æ¶ˆæ¯

**å®é™…ç»“æœ**ï¼šâœ… ç¬¦åˆé¢„æœŸ

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤é€šè¿‡ä»¥ä¸‹ä¸‰ä¸ªå…³é”®æ”¹åŠ¨è§£å†³äº†é‡å¤å›å¤çš„é—®é¢˜ï¼š

1. **é˜²é‡å¤æ£€æŸ¥**ï¼šåœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­æ£€æŸ¥ `_is_processing_reply` æ ‡å¿—
2. **ç»Ÿä¸€å»¶è¿Ÿæœºåˆ¶**ï¼šç¡®ä¿æ‰€æœ‰å›å¤éƒ½æœ‰3ç§’å»¶è¿Ÿ
3. **çŠ¶æ€ç®¡ç†**ï¼šé€šè¿‡ `_is_processing_reply` æ ‡å¿—é˜²æ­¢å¹¶å‘å¤„ç†

è¿™äº›æ”¹åŠ¨ç¡®ä¿äº†ç³»ç»Ÿçš„å›å¤è¡Œä¸ºç¬¦åˆè®¾è®¡é¢„æœŸï¼Œæå‡äº†ç”¨æˆ·ä½“éªŒã€‚

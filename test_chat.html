<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM æµ‹è¯•å·¥å…·</title>
    <style>
        :root {
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #252542;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: #334155;
            --success: #22c55e;
            --warning: #f59e0b;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
        }
        
        /* å·¦ä¾§é…ç½®é¢æ¿ */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        .sidebar h2 {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
        }
        
        .config-group {
            margin-bottom: 24px;
        }
        
        .config-label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        select, input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        select:focus, input:focus {
            border-color: var(--accent);
        }
        
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .toggle-label {
            font-size: 14px;
        }
        
        .toggle {
            width: 44px;
            height: 24px;
            background: var(--border);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .toggle.active {
            background: var(--accent);
        }
        
        .toggle::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.2s;
        }
        
        .toggle.active::after {
            transform: translateX(20px);
        }
        
        /* Tabå¯¼èˆª */
        .tab-nav {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 24px;
        }
        
        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        
        .tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }
        
        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        
        /* Tabå†…å®¹ */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* çŸ¥è¯†åº“ç®¡ç†é¡µé¢ */
        .knowledge-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }
        
        .knowledge-title h2 {
            margin: 0 0 4px 0;
            color: var(--text-primary);
        }
        
        .knowledge-title p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .knowledge-actions {
            display: flex;
            gap: 12px;
        }
        
        .btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
        }
        
        .btn-secondary {
            background: white;
            color: var(--text-secondary);
            border-color: var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--bg-secondary);
        }
        
        /* æœç´¢æ¡† */
        .search-box {
            display: flex;
            align-items: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 16px;
            max-width: 400px;
        }
        
        .search-box input {
            border: none;
            background: transparent;
            outline: none;
            flex: 1;
            font-size: 14px;
            margin-left: 8px;
        }
        
        /* çŸ¥è¯†åº“è¡¨æ ¼ */
        .knowledge-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .knowledge-table th {
            background: var(--bg-secondary);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--accent);
            font-size: 13px;
            border-bottom: 2px solid var(--border);
        }
        
        .knowledge-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            vertical-align: top;
        }
        
        .knowledge-table tr:hover {
            background: var(--bg-secondary);
        }
        
        .category-badge {
            background: #eff6ff;
            color: #2563eb;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .tag {
            background: #f1f5f9;
            color: #64748b;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-right: 4px;
            display: inline-block;
        }
        
        .question-text {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .answer-text {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .edit-btn {
            background: #3b82f6;
            color: white;
        }
        
        .delete-btn {
            background: #ef4444;
            color: white;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }
        .log-area {
            margin-top: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .log-container {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            overflow-y: auto;
            max-height: 300px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 4px;
            word-wrap: break-word;
        }
        
        .log-time {
            color: var(--text-secondary);
            margin-right: 8px;
        }
        
        .log-info { color: var(--text-primary); }
        .log-success { color: var(--success); }
        .log-warning { color: var(--warning); }
        .log-error { color: #ef4444; }
        
        .log-controls {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-clear-btn {
            padding: 4px 8px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .log-clear-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .log-auto-scroll {
            display: flex;
            align-items: center;
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .log-auto-scroll input {
            margin-right: 4px;
        }
        
        .stats {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 6px 0;
            color: var(--text-secondary);
        }
        
        .stat-value {
            color: var(--text-primary);
        }
        
        /* å³ä¾§èŠå¤©åŒºåŸŸ */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .clear-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .clear-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        /* æ¶ˆæ¯åŒºåŸŸ */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .message {
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 16px;
            line-height: 1.6;
            font-size: 14px;
            position: relative;
        }
        
        .message.user {
            align-self: flex-end;
            background: var(--accent);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message.assistant {
            align-self: flex-start;
            background: var(--bg-tertiary);
            border-bottom-left-radius: 4px;
        }
        
        .message-meta {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 8px;
            display: flex;
            gap: 12px;
        }
        
        .message.user .message-meta {
            color: rgba(255,255,255,0.7);
        }
        
        .source-tag {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .source-tag.knowledge {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }
        
        .source-tag.llm {
            background: rgba(99, 102, 241, 0.2);
            color: var(--accent-hover);
        }
        
        .message-image {
            max-width: 200px;
            border-radius: 8px;
            margin-top: 8px;
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            padding: 20px 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }
        
        .input-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .input-wrapper {
            flex: 1;
            position: relative;
        }
        
        #messageInput {
            width: 100%;
            padding: 14px 48px 14px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            min-height: 52px;
            max-height: 150px;
            outline: none;
        }
        
        #messageInput:focus {
            border-color: var(--accent);
        }
        
        .input-actions {
            position: absolute;
            right: 8px;
            bottom: 8px;
            display: flex;
            gap: 4px;
        }
        
        .icon-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .icon-btn:hover {
            background: var(--bg-primary);
            color: var(--accent);
        }
        
        .send-btn, .stop-btn {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .send-btn {
            background: var(--accent);
            color: white;
        }
        
        .send-btn:hover {
            background: var(--accent-hover);
        }
        
        .stop-btn {
            background: var(--warning);
            color: white;
            margin-left: 8px;
        }
        
        .stop-btn:hover {
            background: #d97706;
        }
        
        .send-btn:disabled, .stop-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            gap: 4px;
            padding: 14px 18px;
        }
        
        .loading span {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .loading span:nth-child(1) { animation-delay: -0.32s; }
        .loading span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* éšè—çš„æ–‡ä»¶ä¸Šä¼  */
        #imageInput {
            display: none;
        }
        
        /* æ¬¢è¿æ¶ˆæ¯ */
        .welcome {
            text-align: center;
            padding: 60px 40px;
            color: var(--text-secondary);
        }
        
        .welcome h3 {
            font-size: 24px;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        
        .welcome p {
            font-size: 14px;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <!-- å·¦ä¾§é…ç½®é¢æ¿ -->
    <div class="sidebar">
        <h2>é…ç½®</h2>
        
        <div class="config-group">
            <label class="config-label">é€‰æ‹©æ¨¡å‹</label>
            <select id="modelSelect">
                <option value="é˜¿é‡Œåƒé—®">é˜¿é‡Œåƒé—®</option>
                <option value="DeepSeek">DeepSeek</option>
            </select>
        </div>
        
        <div class="toggle-row">
            <span class="toggle-label">ä¼˜å…ˆçŸ¥è¯†åº“</span>
            <div class="toggle active" id="knowledgeToggle"></div>
        </div>
        
        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="log-area">
            <h2>è¿è¡Œæ—¥å¿—</h2>
            <div class="log-controls">
                <div class="log-auto-scroll">
                    <input type="checkbox" id="autoScrollLog" checked>
                    <label for="autoScrollLog">è‡ªåŠ¨æ»šåŠ¨</label>
                </div>
                <button class="log-clear-btn" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            </div>
            <div class="log-container" id="logContainer">
                <div class="log-entry log-info">
                    <span class="log-time">[00:00:00]</span>
                    ç­‰å¾…æœåŠ¡å¯åŠ¨...
                </div>
            </div>
        </div>
        
        <div class="stats">
            <h2>çŠ¶æ€</h2>
            <div class="stat-item">
                <span>çŸ¥è¯†åº“æ¡ç›®</span>
                <span class="stat-value" id="knowledgeCount">-</span>
            </div>
            <div class="stat-item">
                <span>å½“å‰æ¨¡å‹</span>
                <span class="stat-value" id="currentModel">-</span>
            </div>
            <div class="stat-item">
                <span>å“åº”æ—¶é—´</span>
                <span class="stat-value" id="lastResponseTime">-</span>
            </div>
        </div>
    </div>
    
    <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <!-- Tabå¯¼èˆª -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('chat')">å¯¹è¯æµ‹è¯•</button>
            <button class="tab-btn" onclick="switchTab('knowledge')">çŸ¥è¯†åº“ç®¡ç†</button>
        </div>
        
        <!-- å¯¹è¯æµ‹è¯•Tab -->
        <div id="chatTab" class="tab-content active">
            <div class="chat-container">
                <div class="chat-header">
                    <h1>LLM æµ‹è¯•å¯¹è¯</h1>
                    <button class="clear-btn" onclick="clearHistory()">æ¸…ç©ºå¯¹è¯</button>
                </div>
                
                <div class="messages" id="messages">
                    <div class="welcome">
                        <h2>ğŸ‘‹ å¼€å§‹æµ‹è¯•</h2>
                        <p>è¾“å…¥æ¶ˆæ¯æµ‹è¯•å¤§æ¨¡å‹å›å¤</p>
                        <p>æ”¯æŒåˆ‡æ¢æ¨¡å‹ã€å¼€å…³çŸ¥è¯†åº“åŒ¹é…</p>
                    </div>
                </div>
                
                <div class="input-area">
                    <textarea id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">å‘é€</button>
                    <button class="stop-btn" id="stopBtn" onclick="stopRequest()" style="display: none;">åœæ­¢</button>
                </div>
                <input type="file" id="imageInput" accept="image/*" onchange="handleImageSelect(event)">
            </div>
        </div>
        
        <!-- çŸ¥è¯†åº“ç®¡ç†Tab -->
        <div id="knowledgeTab" class="tab-content">
            <div class="knowledge-header">
                <div class="knowledge-title">
                    <h2>çŸ¥è¯†åº“ç®¡ç†</h2>
                    <p>ç»´æŠ¤ AI çš„å›å¤é€»è¾‘ä¸ä¸šåŠ¡è¯æœ¯</p>
                </div>
                <div class="knowledge-actions">
                    <button class="btn btn-secondary" onclick="exportKnowledge()">å¯¼å‡º</button>
                    <button class="btn btn-secondary" onclick="importKnowledge()">æ‰¹é‡å¯¼å…¥</button>
                    <button class="btn btn-primary" onclick="addKnowledgeItem()">æ·»åŠ è¯æœ¯</button>
                </div>
            </div>
            
            <div class="search-box">
                <span>ğŸ”</span>
                <input type="text" id="knowledgeSearch" placeholder="æœç´¢å…³é”®è¯ã€æ ‡ç­¾æˆ–é—®é¢˜..." oninput="searchKnowledge()">
            </div>
            
            <div class="knowledge-stats" id="knowledgeStats">å…± 0 æ¡</div>
            
            <table class="knowledge-table">
                <thead>
                    <tr>
                        <th>åˆ†ç±»</th>
                        <th>æ ‡ç­¾</th>
                        <th>é—®é¢˜</th>
                        <th>ç­”æ¡ˆ</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="knowledgeTableBody">
                    <!-- åŠ¨æ€åŠ è½½ -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- çŸ¥è¯†åº“ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="knowledgeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">æ·»åŠ çŸ¥è¯†åº“</h3>
            </div>
            <form id="knowledgeForm">
                <div class="form-group">
                    <label for="itemCategory">åˆ†ç±»</label>
                    <select id="itemCategory">
                        <option value="è´­ä¹°æ–¹å¼">è´­ä¹°æ–¹å¼</option>
                        <option value="åœ°å€é—¨åº—">åœ°å€é—¨åº—</option>
                        <option value="é€‰è´­å»ºè®®">é€‰è´­å»ºè®®</option>
                        <option value="å“ç‰Œä»‹ç»">å“ç‰Œä»‹ç»</option>
                        <option value="ä»·æ ¼æŠ¥ä»·">ä»·æ ¼æŠ¥ä»·</option>
                        <option value="å¼‚è®®å¤„ç†">å¼‚è®®å¤„ç†</option>
                        <option value="é¢„çº¦åˆ°åº—">é¢„çº¦åˆ°åº—</option>
                        <option value="ä½©æˆ´ä½“éªŒ">ä½©æˆ´ä½“éªŒ</option>
                        <option value="äº§å“ä»‹ç»">äº§å“ä»‹ç»</option>
                        <option value="å”®åæ”¿ç­–">å”®åæ”¿ç­–</option>
                        <option value="æŠ¤ç†å»ºè®®">æŠ¤ç†å»ºè®®</option>
                        <option value="å¼•å¯¼ç§åŸŸ">å¼•å¯¼ç§åŸŸ</option>
                        <option value="ä¿ƒé”€è§„åˆ™">ä¿ƒé”€è§„åˆ™</option>
                        <option value="éœ€æ±‚æ¢ç´¢">éœ€æ±‚æ¢ç´¢</option>
                        <option value="è½¬ä»‹ç»ä¼šå‘˜">è½¬ä»‹ç»ä¼šå‘˜</option>
                        <option value="ä½¿ç”¨å¯¿å‘½">ä½¿ç”¨å¯¿å‘½</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="itemTags">æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="itemTags" placeholder="å¦‚ï¼šä»·æ ¼,å¼‚è®®å¤„ç†,å”®å‰è¯æœ¯">
                </div>
                
                <div class="form-group">
                    <label for="itemQuestion">é—®é¢˜</label>
                    <textarea id="itemQuestion" placeholder="è¾“å…¥é—®é¢˜..." rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="itemAnswer">ç­”æ¡ˆ</label>
                    <textarea id="itemAnswer" placeholder="è¾“å…¥ç­”æ¡ˆ..." rows="4"></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeKnowledgeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const sessionId = 'test-session-' + Date.now();
        let useKnowledge = true;
        let logIndex = 0;
        let logPollingInterval = null;
        
        // Tabåˆ‡æ¢
        function switchTab(tabName) {
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // å¦‚æœåˆ‡æ¢åˆ°çŸ¥è¯†åº“tabï¼ŒåŠ è½½æ•°æ®
            if (tabName === 'knowledge') {
                loadKnowledgeData();
            }
        }
        
        // çŸ¥è¯†åº“ç®¡ç†åŠŸèƒ½
        let currentEditingItem = null;
        let knowledgeData = [];
        
        // åŠ è½½çŸ¥è¯†åº“æ•°æ®
        async function loadKnowledgeData() {
            try {
                const res = await fetch('/api/knowledge');
                const data = await res.json();
                knowledgeData = data.items || [];
                renderKnowledgeTable();
                updateKnowledgeStats();
            } catch (e) {
                console.error('åŠ è½½çŸ¥è¯†åº“æ•°æ®å¤±è´¥:', e);
            }
        }
        
        // æ¸²æŸ“çŸ¥è¯†åº“è¡¨æ ¼
        function renderKnowledgeTable(searchTerm = '') {
            const tbody = document.getElementById('knowledgeTableBody');
            tbody.innerHTML = '';
            
            let filteredData = knowledgeData;
            if (searchTerm) {
                filteredData = knowledgeData.filter(item => 
                    item.question.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    item.answer.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    item.category.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (item.tags && item.tags.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase())))
                );
            }
            
            filteredData.forEach(item => {
                const row = document.createElement('tr');
                
                // åˆ†ç±»
                const categoryCell = document.createElement('td');
                categoryCell.innerHTML = `<span class="category-badge">${item.category || 'æœªåˆ†ç±»'}</span>`;
                
                // æ ‡ç­¾
                const tagsCell = document.createElement('td');
                const tags = (item.tags || []).slice(0, 2);
                tagsCell.innerHTML = tags.map(tag => `<span class="tag">${tag}</span>`).join('');
                if (item.tags && item.tags.length > 2) {
                    tagsCell.innerHTML += `<span class="tag">+${item.tags.length - 2}</span>`;
                }
                
                // é—®é¢˜
                const questionCell = document.createElement('td');
                questionCell.innerHTML = `<div class="question-text">${item.question}</div>`;
                
                // ç­”æ¡ˆ
                const answerCell = document.createElement('td');
                answerCell.innerHTML = `<div class="answer-text">${item.answer}</div>`;
                
                // æ“ä½œ
                const actionCell = document.createElement('td');
                actionCell.innerHTML = `
                    <div class="action-buttons">
                        <button class="action-btn edit-btn" onclick="editKnowledgeItem('${item.id}')">ç¼–è¾‘</button>
                        <button class="action-btn delete-btn" onclick="deleteKnowledgeItem('${item.id}')">åˆ é™¤</button>
                    </div>
                `;
                
                row.appendChild(categoryCell);
                row.appendChild(tagsCell);
                row.appendChild(questionCell);
                row.appendChild(answerCell);
                row.appendChild(actionCell);
                
                tbody.appendChild(row);
            });
            
            updateKnowledgeStats(filteredData.length);
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateKnowledgeStats(count = null) {
            const stats = document.getElementById('knowledgeStats');
            const actualCount = count !== null ? count : knowledgeData.length;
            stats.textContent = `å…± ${actualCount} æ¡`;
        }
        
        // æœç´¢çŸ¥è¯†åº“
        function searchKnowledge() {
            const searchTerm = document.getElementById('knowledgeSearch').value;
            renderKnowledgeTable(searchTerm);
        }
        
        // æ·»åŠ çŸ¥è¯†åº“é¡¹
        function addKnowledgeItem() {
            currentEditingItem = null;
            document.getElementById('modalTitle').textContent = 'æ·»åŠ çŸ¥è¯†åº“';
            document.getElementById('knowledgeForm').reset();
            document.getElementById('knowledgeModal').classList.add('active');
        }
        
        // ç¼–è¾‘çŸ¥è¯†åº“é¡¹
        function editKnowledgeItem(id) {
            const item = knowledgeData.find(item => item.id === id);
            if (!item) return;
            
            currentEditingItem = item;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘çŸ¥è¯†åº“';
            document.getElementById('itemCategory').value = item.category || '';
            document.getElementById('itemTags').value = (item.tags || []).join('ã€');
            document.getElementById('itemQuestion').value = item.question || '';
            document.getElementById('itemAnswer').value = item.answer || '';
            document.getElementById('knowledgeModal').classList.add('active');
        }
        
        // ä¿å­˜çŸ¥è¯†åº“é¡¹
        async function saveKnowledgeItem() {
            const category = document.getElementById('itemCategory').value;
            const tagsRaw = document.getElementById('itemTags').value;
            const question = document.getElementById('itemQuestion').value.trim();
            const answer = document.getElementById('itemAnswer').value.trim();
            
            if (!question || !answer) {
                alert('é—®é¢˜å’Œç­”æ¡ˆä¸èƒ½ä¸ºç©º');
                return;
            }
            
            const tags = tagsRaw.split(/[ï¼Œ,ã€;ï¼›\s]+/).filter(tag => tag.trim());
            
            const itemData = {
                category,
                tags,
                question,
                answer
            };
            
            try {
                let url = '/api/knowledge';
                let method = 'POST';
                
                if (currentEditingItem) {
                    url += `/${currentEditingItem.id}`;
                    method = 'PUT';
                }
                
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(itemData)
                });
                
                if (res.ok) {
                    closeKnowledgeModal();
                    loadKnowledgeData();
                    addLogEntry(currentEditingItem ? 'çŸ¥è¯†åº“é¡¹å·²æ›´æ–°' : 'çŸ¥è¯†åº“é¡¹å·²æ·»åŠ ', 'success');
                } else {
                    alert('ä¿å­˜å¤±è´¥');
                }
            } catch (e) {
                console.error('ä¿å­˜çŸ¥è¯†åº“é¡¹å¤±è´¥:', e);
                alert('ä¿å­˜å¤±è´¥');
            }
        }
        
        // åˆ é™¤çŸ¥è¯†åº“é¡¹
        async function deleteKnowledgeItem(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡çŸ¥è¯†åº“é¡¹å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const res = await fetch(`/api/knowledge/${id}`, {
                    method: 'DELETE'
                });
                
                if (res.ok) {
                    loadKnowledgeData();
                    addLogEntry('çŸ¥è¯†åº“é¡¹å·²åˆ é™¤', 'success');
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (e) {
                console.error('åˆ é™¤çŸ¥è¯†åº“é¡¹å¤±è´¥:', e);
                alert('åˆ é™¤å¤±è´¥');
            }
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeKnowledgeModal() {
            document.getElementById('knowledgeModal').classList.remove('active');
            document.getElementById('knowledgeForm').reset();
            currentEditingItem = null;
        }
        
        // å¯¼å‡ºçŸ¥è¯†åº“
        async function exportKnowledge() {
            try {
                const res = await fetch('/api/knowledge/export');
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'knowledge_base.json';
                a.click();
                window.URL.revokeObjectURL(url);
                addLogEntry('çŸ¥è¯†åº“å·²å¯¼å‡º', 'success');
            } catch (e) {
                console.error('å¯¼å‡ºå¤±è´¥:', e);
                alert('å¯¼å‡ºå¤±è´¥');
            }
        }
        
        // å¯¼å…¥çŸ¥è¯†åº“
        function importKnowledge() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const res = await fetch('/api/knowledge/import', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (res.ok) {
                        loadKnowledgeData();
                        addLogEntry('çŸ¥è¯†åº“å·²å¯¼å…¥', 'success');
                    } else {
                        alert('å¯¼å…¥å¤±è´¥');
                    }
                } catch (e) {
                    console.error('å¯¼å…¥å¤±è´¥:', e);
                    alert('å¯¼å…¥å¤±è´¥');
                }
            };
            input.click();
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            startLogPolling();
            loadKnowledgeData();
            
            // å›è½¦å‘é€
            document.getElementById('messageInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // çŸ¥è¯†åº“è¡¨å•æäº¤
            document.getElementById('knowledgeForm').addEventListener('submit', (e) => {
                e.preventDefault();
                saveKnowledgeItem();
            });
            
            // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = messageInput.scrollHeight + 'px';
            });
            
            // çŸ¥è¯†åº“å¼€å…³
            document.getElementById('knowledgeToggle').addEventListener('click', function() {
                this.classList.toggle('active');
                useKnowledge = this.classList.contains('active');
            });
            
            // æ¨¡å‹åˆ‡æ¢
            document.getElementById('modelSelect').addEventListener('change', async (e) => {
                const model = e.target.value;
                await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current_model: model })
                });
                document.getElementById('currentModel').textContent = model;
            });
        });
        
        function startLogPolling() {
            // æ¯ç§’è·å–ä¸€æ¬¡æ–°æ—¥å¿—
            logPollingInterval = setInterval(async () => {
                try {
                    const res = await fetch(`/api/logs?since=${logIndex}`);
                    const data = await res.json();
                    
                    if (data.logs && data.logs.length > 0) {
                        const container = document.getElementById('logContainer');
                        const autoScroll = document.getElementById('autoScrollLog').checked;
                        
                        data.logs.forEach(log => {
                            const logEntry = document.createElement('div');
                            logEntry.className = `log-entry log-${log.level}`;
                            logEntry.innerHTML = `
                                <span class="log-time">[${log.time}]</span>
                                ${log.message}
                            `;
                            container.appendChild(logEntry);
                        });
                        
                        // æ›´æ–°æ—¥å¿—ç´¢å¼•
                        logIndex += data.logs.length;
                        
                        // é™åˆ¶æ—¥å¿—æ•°é‡
                        const maxLogs = 100;
                        const entries = container.children;
                        if (entries.length > maxLogs) {
                            for (let i = 0; i < entries.length - maxLogs; i++) {
                                entries[i].remove();
                            }
                        }
                        
                        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                        if (autoScroll) {
                            container.scrollTop = container.scrollHeight;
                        }
                    }
                } catch (e) {
                    console.error('è·å–æ—¥å¿—å¤±è´¥:', e);
                }
            }, 1000);
        }
        
        function clearLogs() {
            const container = document.getElementById('logContainer');
            container.innerHTML = `
                <div class="log-entry log-info">
                    <span class="log-time">[${new Date().toLocaleTimeString('zh-CN', { hour12: false })}]</span>
                    æ—¥å¿—å·²æ¸…ç©º
                </div>
            `;
            logIndex = 0; // é‡ç½®æ—¥å¿—ç´¢å¼•
        }
        
        function addLogEntry(message, level = 'info') {
            const container = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${level}`;
            const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            logEntry.innerHTML = `
                <span class="log-time">[${time}]</span>
                ${message}
            `;
            container.appendChild(logEntry);
            
            // è‡ªåŠ¨æ»šåŠ¨
            if (document.getElementById('autoScrollLog').checked) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                const data = await res.json();
                
                document.getElementById('modelSelect').value = data.current_model;
                document.getElementById('knowledgeCount').textContent = data.knowledge_count;
                document.getElementById('currentModel').textContent = data.current_model;
            } catch (e) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', e);
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            input.style.height = 'auto';
            
            // ç§»é™¤æ¬¢è¿æ¶ˆæ¯
            const welcome = document.querySelector('.welcome');
            if (welcome) welcome.remove();
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            const loadingId = showLoading();
            
            // ç¦ç”¨å‘é€æŒ‰é’®ï¼Œæ˜¾ç¤ºåœæ­¢æŒ‰é’®
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('stopBtn').style.display = 'inline-block';
            
            // æ·»åŠ æ—¥å¿—
            addLogEntry(`ğŸ“¤ å‘é€æ¶ˆæ¯: ${message.substring(0, 50)}${message.length > 50 ? '...' : ''}`, 'info');
            
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message,
                        session_id: sessionId,
                        use_knowledge: useKnowledge
                    })
                });
                
                const data = await res.json();
                
                // ç§»é™¤åŠ è½½åŠ¨ç”»
                removeLoading(loadingId);
                
                if (data.error) {
                    addMessage('é”™è¯¯: ' + data.error, 'assistant');
                    addLogEntry(`âŒ è¯·æ±‚å¤±è´¥: ${data.error}`, 'error');
                } else {
                    addMessage(data.reply, 'assistant', {
                        source: data.source,
                        model: data.model,
                        time: data.time_ms
                    });
                    
                    document.getElementById('lastResponseTime').textContent = data.time_ms + 'ms';
                    
                    // æ·»åŠ æˆåŠŸæ—¥å¿—
                    const sourceText = data.source === 'knowledge' ? 'çŸ¥è¯†åº“' : 'LLM';
                    addLogEntry(`âœ… æ”¶åˆ°å›å¤ (${sourceText}): ${data.reply.substring(0, 30)}...`, 'success');
                }
            } catch (e) {
                removeLoading(loadingId);
                addMessage('è¯·æ±‚å¤±è´¥: ' + e.message, 'assistant');
                addLogEntry(`âŒ ç½‘ç»œé”™è¯¯: ${e.message}`, 'error');
            }
            
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('stopBtn').style.display = 'none';
        }
        
        function addMessage(content, role, meta = null) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'message ' + role;
            
            let html = content.replace(/\n/g, '<br>');
            
            if (meta) {
                html += `<div class="message-meta">`;
                if (meta.source) {
                    const sourceLabel = meta.source === 'knowledge' ? 'çŸ¥è¯†åº“' : 'LLM';
                    html += `<span class="source-tag ${meta.source}">${sourceLabel}</span>`;
                }
                if (meta.model) {
                    html += `<span>${meta.model}</span>`;
                }
                if (meta.time) {
                    html += `<span>${meta.time}ms</span>`;
                }
                html += `</div>`;
            }
            
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        function showLoading() {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'message assistant loading';
            div.id = 'loading-' + Date.now();
            div.innerHTML = '<span></span><span></span><span></span>';
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div.id;
        }
        
        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }
        
        async function stopRequest() {
            try {
                addLogEntry('ğŸ›‘ ç”¨æˆ·è¯·æ±‚åœæ­¢...', 'warning');
                
                const res = await fetch('/api/chat/cancel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();
                
                // ç§»é™¤åŠ è½½åŠ¨ç”»
                const loadingElements = document.querySelectorAll('.loading');
                loadingElements.forEach(el => el.remove());
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
                
                if (data.success) {
                    addMessage('è¯·æ±‚å·²å–æ¶ˆ', 'assistant');
                    addLogEntry('âœ… è¯·æ±‚å·²æˆåŠŸå–æ¶ˆ', 'success');
                } else {
                    addMessage('å–æ¶ˆå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'assistant');
                    addLogEntry(`âŒ å–æ¶ˆå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (e) {
                addMessage('å–æ¶ˆè¯·æ±‚å¤±è´¥: ' + e.message, 'assistant');
                addLogEntry(`âŒ å–æ¶ˆè¯·æ±‚å¼‚å¸¸: ${e.message}`, 'error');
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
            }
        }
        
        async function clearHistory() {
            await fetch('/api/history?session_id=' + sessionId, { method: 'DELETE' });
            const container = document.getElementById('messages');
            container.innerHTML = `
                <div class="welcome">
                    <h3>å¼€å§‹æµ‹è¯•</h3>
                    <p>è¾“å…¥æ¶ˆæ¯æµ‹è¯•å¤§æ¨¡å‹å›å¤<br>æ”¯æŒåˆ‡æ¢æ¨¡å‹ã€å¼€å…³çŸ¥è¯†åº“åŒ¹é…</p>
                </div>
            `;
        }
        
        async function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const res = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                if (data.success) {
                    // æ˜¾ç¤ºå·²ä¸Šä¼ çš„å›¾ç‰‡
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const welcome = document.querySelector('.welcome');
                        if (welcome) welcome.remove();
                        
                        const container = document.getElementById('messages');
                        const div = document.createElement('div');
                        div.className = 'message user';
                        div.innerHTML = `<img src="${e.target.result}" class="message-image">`;
                        container.appendChild(div);
                        container.scrollTop = container.scrollHeight;
                        
                        addMessage(`ğŸ“· å›¾ç‰‡å·²ä¸Šä¼ : ${data.filename}`, 'assistant');
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + data.error);
                }
            } catch (e) {
                alert('ä¸Šä¼ å¤±è´¥: ' + e.message);
            }
            
            event.target.value = '';
        }
    </script>
</body>
</html>
